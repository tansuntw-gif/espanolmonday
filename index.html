<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥¿èªå­¸ç¿’å¤§å¸« - æµç¨‹å„ªåŒ–ç‰ˆ</title>
    <style>
        :root { --primary: #007AFF; --secondary: #8E8E93; --success: #34C759; --danger: #FF3B30; --voice: #5856D6; --clear: #FF9500; }
        body { font-family: -apple-system, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { width: 90%; max-width: 450px; padding: 25px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        .menu-grid { display: grid; grid-template-columns: repeat(1, 1fr); gap: 10px; margin-top: 20px; max-height: 400px; overflow-y: auto; padding: 5px; }
        .lesson-btn { background: white; border: 2px solid var(--primary); color: var(--primary); padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; text-align: left; }
        .lesson-btn:hover { background: var(--primary); color: white; }
        
        .quiz-container { display: none; }
        .stats-bar { display: flex; justify-content: space-between; font-size: 14px; color: #666; margin-bottom: 10px; }
        .progress-container { width: 100%; background-color: #eee; border-radius: 10px; height: 10px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { background-color: var(--success); height: 100%; width: 0%; transition: 0.5s; }
        
        #chinese-text { font-size: 20px; font-weight: bold; margin: 20px 0; min-height: 50px; color: #333; line-height: 1.4; }
        
        textarea {
            width: 100%; padding: 15px; font-size: 18px; border: 2px solid #ddd; border-radius: 12px;
            margin-bottom: 15px; text-align: left; outline: none; box-sizing: border-box;
            resize: none; font-family: inherit; line-height: 1.5; transition: 0.3s;
        }
        textarea:focus { border-color: var(--primary); background-color: #fafafa; }

        .ans-display { font-size: 18px; color: var(--primary); font-weight: bold; margin-bottom: 15px; display: none; background: #eef7ff; padding: 10px; border-radius: 10px; cursor: pointer; }
        button.action-btn { width: 100%; border: none; padding: 15px; border-radius: 12px; font-size: 18px; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: 0.3s; color: white; }
        
        .input-tools { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .btn-mic { background-color: var(--voice); }
        .btn-clear { background-color: var(--clear); }
        .btn-send { background-color: var(--primary); }
        .btn-next { background-color: var(--success); }
        
        .btn-back { background: none; color: var(--secondary); font-size: 14px; text-decoration: underline; border: none; cursor: pointer; margin-top: 10px; }
        
        #mic-btn.listening { background-color: var(--danger) !important; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="card" id="menu-screen">
    <h2 style="margin-top:0">è¥¿ç­ç‰™èªç·´ç¿’</h2>
    <p style="color:#666">ç¬¬ 5 èª²è‡³ç¬¬ 8 èª² (æµç¨‹å„ªåŒ–ç‰ˆ)</p>
    <div class="menu-grid" id="lesson-menu"></div>
</div>

<div class="card quiz-container" id="quiz-screen">
    <div class="stats-bar">
        <div id="current-lesson-name">è¼‰å…¥ä¸­...</div>
        <div id="progress-text">å®Œæˆé€²åº¦: 0%</div>
    </div>
    <div class="progress-container">
        <div class="progress-fill" id="progress-bar"></div>
    </div>

    <div id="chinese-text">é¡Œç›®è¼‰å…¥ä¸­...</div>

    <textarea id="user-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥ã€æˆ–é–‹å§‹å£èªª..." rows="3"></textarea>
    
    <div class="input-tools">
        <button id="mic-btn" class="action-btn btn-mic" onclick="toggleListening()">ğŸ¤ é–‹å§‹å£èªª</button>
        <button class="action-btn btn-clear" onclick="clearContent()">ğŸ—‘ï¸ æ¸…é™¤å…§å®¹</button>
    </div>

    <div id="feedback" style="margin-bottom:10px; font-weight:bold;"></div>
    <div id="ans-display" class="ans-display" onclick="speakCurrent()"></div>
    
    <div class="btn-group">
        <button id="send-btn" class="action-btn btn-send" onclick="checkAnswer()">ğŸš€ é€å‡ºç­”æ¡ˆ</button>
        <button class="action-btn btn-next" onclick="nextQuestion()">â¡ï¸ ä¸‹ä¸€é¡Œ</button>
        <button class="btn-back" onclick="goToMenu()">å›ä¸»é¸å–®</button>
    </div>
</div>

<script src="lessons.js"></script>

<script>
    let currentQuestions = [];
    let currentIndex = 0;
    let recognitionTimer;
    let isUserStopping = false;

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'es-ES';
        recognition.continuous = true;
        recognition.interimResults = false;

        recognition.onresult = (e) => {
            const transcript = e.results[e.results.length - 1][0].transcript;
            const userInput = document.getElementById('user-input');
            userInput.value += (userInput.value ? " " : "") + transcript;
            userInput.focus();
        };

        recognition.onend = () => {
            const btn = document.getElementById('mic-btn');
            if (!isUserStopping && btn.classList.contains('listening')) {
                try { recognition.start(); } catch (e) { resetMicBtn(); }
            } else {
                resetMicBtn();
            }
        };

        recognition.onerror = () => resetMicBtn();
    }

    function toggleListening() {
        if (!recognition) return alert("ä¸æ”¯æ´å£èªª");
        const btn = document.getElementById('mic-btn');

        if (btn.classList.contains('listening')) {
            forceStopListening();
        } else {
            isUserStopping = false;
            try {
                recognition.start();
                btn.classList.add('listening');
                btn.innerText = "è½å–ä¸­ (é»æ“ŠçµæŸ)";
                
                clearTimeout(recognitionTimer);
                recognitionTimer = setTimeout(() => {
                    if (btn.classList.contains('listening')) forceStopListening();
                }, 15000);
            } catch (e) { console.error(e); }
        }
    }

    // --- ä¿®æ­£ï¼šå¼·åˆ¶çµ‚æ­¢è†è½çš„çµ±ä¸€å‡½å¼ ---
    function forceStopListening() {
        isUserStopping = true;
        if (recognition) recognition.stop();
        resetMicBtn();
    }

    function resetMicBtn() {
        const btn = document.getElementById('mic-btn');
        btn.classList.remove('listening');
        btn.innerText = "ğŸ¤ é–‹å§‹å£èªª";
        clearTimeout(recognitionTimer);
    }

    function clearContent() {
        const userInput = document.getElementById('user-input');
        userInput.value = "";
        userInput.focus();
    }

    // --- ä¿®æ­£ï¼šé€å‡ºç­”æ¡ˆæ™‚çµ‚æ­¢è†è½ ---
    function checkAnswer() {
        // å¦‚æœæ­£åœ¨å£èªªï¼Œå…ˆå¼·åˆ¶åœæ­¢
        forceStopListening();

        const userInput = document.getElementById('user-input');
        const userValue = userInput.value.trim();
        const feedback = document.getElementById('feedback');
        const correctAnswer = currentQuestions[currentIndex].sp;
        const userClean = normalizeText(userValue);
        const correctClean = normalizeText(correctAnswer);

        if (userClean === correctClean && userValue !== "") {
            feedback.innerText = "Â¡Excelente! ç­”å°äº†ï¼ğŸŒŸ";
            feedback.style.color = "var(--success)";
            userInput.style.borderColor = "var(--success)";
        } else {
            feedback.innerText = "ä¸å®Œå…¨æ­£ç¢ºï¼Œè«‹åƒè€ƒä¸‹æ–¹ç­”æ¡ˆï¼š";
            feedback.style.color = "var(--danger)";
            userInput.style.borderColor = "var(--danger)";
        }
        showFullAnswer(correctAnswer);
    }

    function initMenu() {
        const menu = document.getElementById('lesson-menu');
        menu.innerHTML = "";
        Object.keys(allLessons).forEach(name => {
            const btn = document.createElement('button');
            btn.className = 'lesson-btn'; btn.innerText = name;
            btn.onclick = () => startLesson(name); menu.appendChild(btn);
        });
    }

    function startLesson(name) {
        currentQuestions = [...allLessons[name]].sort(() => Math.random() - 0.5);
        currentIndex = 0;
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('quiz-screen').style.display = 'block';
        document.getElementById('current-lesson-name').innerText = name;
        showQuestion();
    }

    function showQuestion() {
        const q = currentQuestions[currentIndex];
        document.getElementById('chinese-text').innerText = q.ch;
        const userInput = document.getElementById('user-input');
        userInput.value = ""; 
        userInput.style.borderColor = "#ddd";
        document.getElementById('feedback').innerText = "";
        document.getElementById('ans-display').style.display = "none";
        updateProgress();
        userInput.focus();
    }

    function updateProgress() {
        const percent = Math.round(((currentIndex) / currentQuestions.length) * 100);
        document.getElementById('progress-text').innerText = `å®Œæˆé€²åº¦: ${percent}%`;
        document.getElementById('progress-bar').style.width = `${percent}%`;
    }

    function normalizeText(text) {
        return text.toLowerCase().replace(/[Â¿?.,!]/g, "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
    }

    function showFullAnswer(text) {
        const ansDisp = document.getElementById('ans-display');
        const words = text.split(' ');
        ansDisp.innerHTML = words.map(word => /[Ã¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘]/.test(word) ? `<span style="color:red; font-weight:bold;">${word}</span>` : word).join(' ') + " ğŸ”Š";
        ansDisp.style.display = "block";
        speak(text);
    }

    function nextQuestion() {
        if (currentIndex < currentQuestions.length - 1) { 
            currentIndex++; 
            showQuestion(); 
        } else { 
            document.getElementById('progress-text').innerText = `å®Œæˆé€²åº¦: 100%`;
            document.getElementById('progress-bar').style.width = `100%`;
            setTimeout(() => { alert("æ­å–œå®Œæˆæœ¬èª²æ‰€æœ‰ç·´ç¿’ï¼"); goToMenu(); }, 500);
        }
    }

    function goToMenu() { document.getElementById('menu-screen').style.display = 'block'; document.getElementById('quiz-screen').style.display = 'none'; }
    function speak(text) { const u = new SpeechSynthesisUtterance(text); u.lang = 'es-ES'; window.speechSynthesis.speak(u); }
    function speakCurrent() { speak(currentQuestions[currentIndex].sp); }

    initMenu();
</script>
</body>
</html>
    function nextQuestion() {
        if (currentIndex < currentQuestions.length - 1) { 
            currentIndex++; 
            showQuestion(); 
        } else { 
            document.getElementById('progress-text').innerText = `å®Œæˆé€²åº¦: 100%`;
            document.getElementById('progress-bar').style.width = `100%`;
            setTimeout(() => { alert("æ­å–œå®Œæˆæœ¬èª²æ‰€æœ‰ç·´ç¿’ï¼"); goToMenu(); }, 500);
        }
    }

    function goToMenu() { document.getElementById('menu-screen').style.display = 'block'; document.getElementById('quiz-screen').style.display = 'none'; }
    function speak(text) { const u = new SpeechSynthesisUtterance(text); u.lang = 'es-ES'; window.speechSynthesis.speak(u); }
    function speakCurrent() { speak(currentQuestions[currentIndex].sp); }

    initMenu();
</script>
</body>
</html>

