<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥¿èªå­¸ç¿’å¤§å¸« - æœ€çµ‚å¼·åŒ–ç‰ˆ</title>
    <style>
        :root { --primary: #007AFF; --secondary: #6c757d; --success: #34C759; --danger: #FF3B30; --voice: #5856D6; --warn: #FF9500; }
        body { font-family: -apple-system, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { width: 90%; max-width: 450px; padding: 25px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        .menu-grid { display: grid; grid-template-columns: repeat(1, 1fr); gap: 10px; margin-top: 20px; max-height: 400px; overflow-y: auto; padding: 5px; }
        .lesson-btn { background: white; border: 2px solid var(--primary); color: var(--primary); padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; text-align: left; }
        .lesson-btn:hover { background: var(--primary); color: white; }
        .quiz-container { display: none; }
        .stats-bar { display: flex; justify-content: space-between; font-size: 14px; color: #666; margin-bottom: 15px; }
        #chinese-text { font-size: 20px; font-weight: bold; margin: 20px 0; min-height: 50px; color: #333; line-height: 1.4; }
        
        textarea {
            width: 100%; padding: 15px; font-size: 18px; border: 2px solid #ddd; border-radius: 12px;
            margin-bottom: 15px; text-align: left; outline: none; box-sizing: border-box;
            resize: none; font-family: inherit; line-height: 1.5; transition: 0.3s;
        }
        textarea:focus { border-color: var(--primary); background-color: #fafafa; }

        .ans-display { font-size: 18px; color: var(--primary); font-weight: bold; margin-bottom: 15px; display: none; background: #eef7ff; padding: 10px; border-radius: 10px; cursor: pointer; }
        button.action-btn { width: 100%; border: none; padding: 15px; border-radius: 12px; font-size: 18px; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: 0.3s; }
        .btn-check { background: var(--primary); color: white; }
        .btn-next { background: var(--secondary); color: white; }
        .btn-back { background: none; color: var(--secondary); font-size: 14px; text-decoration: underline; border: none; cursor: pointer; }
        #correct-btn { background-color: var(--warn); color: white; display: none; }
        #mic-btn.listening { background-color: var(--danger) !important; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="card" id="menu-screen">
    <h2 style="margin-top:0">è¥¿ç­ç‰™èªç·´ç¿’</h2>
    <p style="color:#666">ç¬¬ 5 èª²è‡³ç¬¬ 8 èª² (é€²éšèªéŸ³ç‰ˆ)</p>
    <div class="menu-grid" id="lesson-menu"></div>
</div>

<div class="card quiz-container" id="quiz-screen">
    <div class="stats-bar">
        <div id="current-lesson-name">è¼‰å…¥ä¸­...</div>
        <div id="progress">0 / 0</div>
        <div id="score">å¾—åˆ†: 0</div>
    </div>
    <div id="chinese-text">é¡Œç›®è¼‰å…¥ä¸­...</div>

    <textarea id="user-input" placeholder="è«‹è¼¸å…¥æˆ–ç”¨èªªçš„..." oninput="handleTyping()" rows="3"></textarea>
    
    <button id="mic-btn" class="action-btn" style="background-color: var(--voice); color: white;" onclick="startListening()">
        ğŸ¤ æŒ‰ä¸‹é–‹å§‹å£èªª
    </button>

    <div id="feedback" style="margin-bottom:10px; font-weight:bold;"></div>
    <div id="ans-display" class="ans-display" onclick="speakCurrent()"></div>
    
    <div class="btn-group">
        <button id="check-btn" class="action-btn btn-check" onclick="checkAnswer()">æª¢æŸ¥ç­”æ¡ˆ</button>
        <button id="correct-btn" class="action-btn" onclick="checkCorrection()">è¨‚æ­£ä¸­...</button>
        <button class="action-btn btn-next" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ</button>
        <button class="btn-back" onclick="goToMenu()">å›ä¸»é¸å–®</button>
    </div>
</div>

<script src="lessons.js"></script>

<script>
    let currentQuestions = [];
    let currentIndex = 0;
    let currentScore = 0;
    let attemptCount = 0;
    let isCorrecting = false;
    let recognitionTimer;

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'es-ES';
        recognition.continuous = true; // é–‹å•Ÿé€£çºŒè¾¨è­˜ï¼Œæ”¯æ´åœé “æ¥é¾
        recognition.interimResults = false;

        recognition.onresult = (e) => {
            const transcript = e.results[e.results.length - 1][0].transcript;
            const userInput = document.getElementById('user-input');
            
            // èªéŸ³æ¥é¾ï¼šä¸æ¸…é™¤èˆŠæ–‡å­—ï¼Œå°‡æ–°ç‰‡æ®µæ¥åœ¨å¾Œé¢
            userInput.value += (userInput.value ? " " : "") + transcript;
            userInput.focus();

            // å³æ™‚åæ‡‰
            if (isCorrecting) {
                handleTyping();
            } else {
                // è‹¥å·²ç­”å°æƒ³é‡è¤‡æ¸¬è©¦ï¼Œå£èªªå®Œè‡ªå‹•é‡æ–°åˆ¤å®š
                if (document.getElementById('check-btn').innerText.includes("å†æ¬¡æª¢æŸ¥")) {
                    checkAnswer();
                }
            }
        };

        recognition.onend = () => {
            const btn = document.getElementById('mic-btn');
            // è‹¥ 15 ç§’æœªåˆ°ä¸”ä»è™•æ–¼è†è½ç‹€æ…‹ï¼Œè‡ªå‹•é‡å•Ÿç¢ºä¿ä¸ä¸­æ–·
            if (btn.classList.contains('listening')) {
                recognition.start();
            } else {
                resetMicBtn();
            }
        };
    }

    function startListening() {
        if (!recognition) return alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å£èªª");
        const btn = document.getElementById('mic-btn');
        if (btn.classList.contains('listening')) {
            stopRecognition();
            return;
        }

        try {
            recognition.start();
            btn.classList.add('listening');
            btn.innerText = "æ­£åœ¨è½... (é»æ“ŠçµæŸ)";

            clearTimeout(recognitionTimer);
            recognitionTimer = setTimeout(() => {
                if (btn.classList.contains('listening')) {
                    stopRecognition();
                    document.getElementById('feedback').innerText = "è†è½é€¾æ™‚ (15ç§’)";
                }
            }, 15000);
        } catch (e) { console.error(e); }
    }

    function stopRecognition() {
        if (recognition) {
            recognition.stop();
            resetMicBtn();
            // åœæ­¢å¾Œè‡ªå‹•æª¢æŸ¥ä¸€æ¬¡ç­”æ¡ˆ
            if (!isCorrecting) checkAnswer();
        }
    }

    function resetMicBtn() {
        const btn = document.getElementById('mic-btn');
        btn.classList.remove('listening');
        btn.innerText = "ğŸ¤ æŒ‰ä¸‹é–‹å§‹å£èªª";
    }

    function initMenu() {
        const menu = document.getElementById('lesson-menu');
        menu.innerHTML = "";
        Object.keys(allLessons).forEach(name => {
            const btn = document.createElement('button');
            btn.className = 'lesson-btn'; btn.innerText = name;
            btn.onclick = () => startLesson(name); menu.appendChild(btn);
        });
    }

    function startLesson(name) {
        currentQuestions = [...allLessons[name]].sort(() => Math.random() - 0.5);
        currentIndex = 0; currentScore = 0;
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('quiz-screen').style.display = 'block';
        document.getElementById('current-lesson-name').innerText = name;
        showQuestion();
    }

    function showQuestion() {
        attemptCount = 0; isCorrecting = false;
        const q = currentQuestions[currentIndex];
        document.getElementById('chinese-text').innerText = q.ch;
        const userInput = document.getElementById('user-input');
        userInput.value = ""; userInput.style.borderColor = "#ddd"; userInput.disabled = false;
        userInput.placeholder = "è«‹è¼¸å…¥æˆ–ç”¨èªªçš„...";
        document.getElementById('feedback').innerText = "";
        document.getElementById('ans-display').style.display = "none";
        document.getElementById('correct-btn').style.display = "none";
        document.getElementById('progress').innerText = `${currentIndex + 1} / ${currentQuestions.length}`;
        document.getElementById('score').innerText = `å¾—åˆ†: ${currentScore}`;
        const checkBtn = document.getElementById('check-btn');
        checkBtn.disabled = false; checkBtn.innerText = "æª¢æŸ¥ç­”æ¡ˆ"; checkBtn.style.backgroundColor = "var(--primary)";
        userInput.focus();
    }

    function checkAnswer() {
        const userInput = document.getElementById('user-input');
        const userValue = userInput.value.trim();
        const checkBtn = document.getElementById('check-btn');
        const feedback = document.getElementById('feedback');
        const correctAnswer = currentQuestions[currentIndex].sp;
        
        const userClean = normalizeText(userValue);
        const correctClean = normalizeText(correctAnswer);

        // æ ¸å¿ƒé‚è¼¯ï¼šç­”å°æˆ–é»æ“Šã€Œé¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆã€æŒ‰éˆ•
        if (checkBtn.innerText === "é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ" || (userClean === correctClean && userValue !== "")) {
            if (userClean === correctClean) {
                if (attemptCount !== -1) { currentScore += 10; attemptCount = -1; }
                feedback.innerText = "Â¡Excelente! ç­”å°äº†ï¼ğŸŒŸ";
                feedback.style.color = "var(--success)";
            } else {
                feedback.innerText = "æ­£ç¢ºç­”æ¡ˆå¦‚ä¸‹ï¼š";
                feedback.style.color = "var(--voice)";
            }
            showFullAnswer(correctAnswer);
            checkBtn.innerText = "å†æ¬¡æª¢æŸ¥ (å·²éé—œ)";
            checkBtn.style.backgroundColor = "var(--success)";
            checkBtn.disabled = false;
        } else {
            attemptCount++;
            if (attemptCount === 1) {
                feedback.innerText = "ä¸å®Œå…¨æ­£ç¢ºï¼Œè«‹ä¿®æ­£æˆ–å†æŒ‰ä¸€æ¬¡é¡¯ç¤ºç­”æ¡ˆã€‚";
                feedback.style.color = "var(--danger)";
                userInput.style.borderColor = "var(--danger)";
                checkBtn.innerText = "é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ";
                checkBtn.style.backgroundColor = "var(--warn)";
            } else {
                isCorrecting = true;
                showFullAnswer(correctAnswer);
                userInput.value = "";
                userInput.placeholder = "è«‹ç…§è‘—è¼¸å…¥ä¸€æ¬¡ä»¥è¨‚æ­£...";
                checkBtn.innerText = "è«‹æŒ‰ä¸‹ä¸€é¡Œ";
                checkBtn.disabled = true;
                document.getElementById('correct-btn').style.display = "block";
                document.getElementById('correct-btn').innerText = "è¨‚æ­£ä¸­...";
                document.getElementById('correct-btn').style.backgroundColor = "var(--warn)";
            }
        }
    }

    function handleTyping() {
        const userInput = document.getElementById('user-input');
        const checkBtn = document.getElementById('check-btn');
        
        if (isCorrecting) {
            const correctBtn = document.getElementById('correct-btn');
            const correctAnswer = currentQuestions[currentIndex].sp;
            if (normalizeText(userInput.value) === normalizeText(correctAnswer)) {
                correctBtn.innerText = "è¨‚æ­£å®Œæˆ <";
                correctBtn.style.backgroundColor = "var(--success)";
                correctBtn.disabled = false;
                userInput.style.borderColor = "var(--success)";
            } else {
                correctBtn.innerText = "è¨‚æ­£ä¸­...";
                correctBtn.disabled = true;
                correctBtn.style.backgroundColor = "var(--warn)";
            }
            return;
        }

        // ç­”å°å¾Œé‡è¤‡æ¸¬è©¦æ™‚ï¼Œè¼¸å…¥è®Šå‹•å°±é‡ç½®æŒ‰éˆ•æ–‡å­—
        if (checkBtn.innerText.includes("å†æ¬¡æª¢æŸ¥")) {
            checkBtn.innerText = "æª¢æŸ¥ç­”æ¡ˆ";
            checkBtn.style.backgroundColor = "var(--primary)";
        }
        userInput.style.borderColor = "#ddd";
    }

    function checkCorrection() {
        document.getElementById('feedback').innerText = "è¨‚æ­£æˆåŠŸï¼è«‹é»æ“Šã€Œä¸‹ä¸€é¡Œã€ã€‚";
        document.querySelector('.btn-next').style.backgroundColor = "var(--primary)";
    }

    function normalizeText(text) {
        return text.toLowerCase().replace(/[Â¿?.,!]/g, "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
    }

    function showFullAnswer(text) {
        const ansDisp = document.getElementById('ans-display');
        const words = text.split(' ');
        ansDisp.innerHTML = words.map(word => /[Ã¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘]/.test(word) ? `<span style="color:red; font-weight:bold;">${word}</span>` : word).join(' ') + " ğŸ”Š";
        ansDisp.style.display = "block";
        speak(text);
    }

    function nextQuestion() {
        if (currentIndex < currentQuestions.length - 1) { 
            currentIndex++; showQuestion(); 
            document.querySelector('.btn-next').style.backgroundColor = "var(--secondary)";
        } else { alert("èª²ç¨‹çµæŸï¼"); goToMenu(); }
    }

    function goToMenu() { document.getElementById('menu-screen').style.display = 'block'; document.getElementById('quiz-screen').style.display = 'none'; }
    function speak(text) { const u = new SpeechSynthesisUtterance(text); u.lang = 'es-ES'; window.speechSynthesis.speak(u); }
    function speakCurrent() { speak(currentQuestions[currentIndex].sp); }

    initMenu();
</script>
</body>
</html>







