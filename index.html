<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥¿èªå­¸ç¿’å¤§å¸« - å°ˆæ¥­ç·´ç¿’ç‰ˆ</title>
    <style>
        :root { --primary: #007AFF; --secondary: #6c757d; --success: #34C759; --danger: #FF3B30; --voice: #5856D6; --warn: #FF9500; --clear: #8E8E93; --send: #007AFF; }
        body { font-family: -apple-system, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { width: 90%; max-width: 450px; padding: 25px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        .menu-grid { display: grid; grid-template-columns: repeat(1, 1fr); gap: 10px; margin-top: 20px; max-height: 400px; overflow-y: auto; padding: 5px; }
        .lesson-btn { background: white; border: 2px solid var(--primary); color: var(--primary); padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; text-align: left; }
        .lesson-btn:hover { background: var(--primary); color: white; }
        .quiz-container { display: none; }
        .stats-bar { display: flex; justify-content: space-between; font-size: 14px; color: #666; margin-bottom: 15px; }
        #chinese-text { font-size: 20px; font-weight: bold; margin: 20px 0; min-height: 50px; color: #333; line-height: 1.4; }
        
        textarea {
            width: 100%; padding: 15px; font-size: 18px; border: 2px solid #ddd; border-radius: 12px;
            margin-bottom: 15px; text-align: left; outline: none; box-sizing: border-box;
            resize: none; font-family: inherit; line-height: 1.5; transition: 0.3s;
        }
        textarea:focus { border-color: var(--primary); background-color: #fafafa; }

        .ans-display { font-size: 18px; color: var(--primary); font-weight: bold; margin-bottom: 15px; display: none; background: #eef7ff; padding: 10px; border-radius: 10px; cursor: pointer; }
        button.action-btn { width: 100%; border: none; padding: 15px; border-radius: 12px; font-size: 18px; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: 0.3s; }
        
        .input-tools { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        
        .btn-send { background: var(--send); color: white; }
        .btn-next { background: var(--secondary); color: white; }
        .btn-back { background: none; color: var(--secondary); font-size: 14px; text-decoration: underline; border: none; cursor: pointer; }
        
        #correct-btn { background-color: var(--warn); color: white; display: none; }
        #mic-btn.listening { background-color: var(--danger) !important; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="card" id="menu-screen">
    <h2 style="margin-top:0">è¥¿ç­ç‰™èªç·´ç¿’</h2>
    <p style="color:#666">ç¬¬ 5 èª²è‡³ç¬¬ 8 èª² (åé¥‹å¼·åŒ–ç‰ˆ)</p>
    <div class="menu-grid" id="lesson-menu"></div>
</div>

<div class="card quiz-container" id="quiz-screen">
    <div class="stats-bar">
        <div id="current-lesson-name">è¼‰å…¥ä¸­...</div>
        <div id="progress">0 / 0</div>
        <div id="score">å¾—åˆ†: 0</div>
    </div>
    <div id="chinese-text">é¡Œç›®è¼‰å…¥ä¸­...</div>

    <textarea id="user-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥ã€æˆ–ä½¿ç”¨å£èªª..." oninput="handleTyping()" rows="3"></textarea>
    
    <div class="input-tools">
        <button id="mic-btn" class="action-btn" style="background-color: var(--voice); color: white; margin-bottom: 0;" onclick="startListening()">
            ğŸ¤ é–‹å§‹å£èªª
        </button>
        <button id="clear-btn" class="action-btn" style="background-color: var(--clear); color: white; margin-bottom: 0;" onclick="clearContent()">
            ğŸ—‘ï¸ æ¸…é™¤å…§å®¹
        </button>
    </div>

    <div id="feedback" style="margin-bottom:10px; font-weight:bold;"></div>
    <div id="ans-display" class="ans-display" onclick="speakCurrent()"></div>
    
    <div class="btn-group" style="margin-top: 10px;">
        <button id="check-btn" class="action-btn btn-send" onclick="checkAnswer()">ğŸš€ é€å‡ºç­”æ¡ˆ</button>
        <button id="correct-btn" class="action-btn" onclick="checkCorrection()">è¨‚æ­£ä¸­...</button>
        <button class="action-btn btn-next" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ</button>
        <button class="btn-back" onclick="goToMenu()">å›ä¸»é¸å–®</button>
    </div>
</div>

<script src="lessons.js"></script>

<script>
    let currentQuestions = [];
    let currentIndex = 0;
    let currentScore = 0;
    let attemptCount = 0;
    let isCorrecting = false;
    let hasBeenCorrect = false; // ç´€éŒ„è©²é¡Œæ˜¯å¦æ›¾ç¶“ç­”å°é
    let recognitionTimer;

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'es-ES';
        recognition.continuous = true; 
        recognition.interimResults = false;

        recognition.onresult = (e) => {
            const transcript = e.results[e.results.length - 1][0].transcript;
            const userInput = document.getElementById('user-input');
            userInput.value += (userInput.value ? " " : "") + transcript;
            userInput.focus();
            
            // æ¯æ¬¡å£èªªæ›´æ–°å…§å®¹ï¼Œå°±è¦–åŒæ–°çš„é–‹å§‹ï¼Œé‡ç½®æŒ‰éˆ•ç‹€æ…‹
            if (!isCorrecting) resetSendButton();
            else handleTyping();
        };

        recognition.onend = () => {
            const btn = document.getElementById('mic-btn');
            if (btn.classList.contains('listening')) recognition.start();
            else resetMicBtn();
        };
    }

    function clearContent() {
        const userInput = document.getElementById('user-input');
        userInput.value = "";
        userInput.focus();
        if (!isCorrecting) resetSendButton();
        else handleTyping();
    }

    function startListening() {
        if (!recognition) return alert("ä¸æ”¯æ´å£èªª");
        const btn = document.getElementById('mic-btn');
        if (btn.classList.contains('listening')) { stopRecognition(); return; }

        // é–‹å§‹å£èªªå³è¦–ç‚ºæ–°é–‹å§‹ï¼Œé‡ç½®é€å‡ºæŒ‰éˆ•
        if (!isCorrecting) resetSendButton();

        try {
            recognition.start();
            btn.classList.add('listening');
            btn.innerText = "è½å–ä¸­ (é»æ“ŠçµæŸ)";
            clearTimeout(recognitionTimer);
            recognitionTimer = setTimeout(() => {
                if (btn.classList.contains('listening')) stopRecognition();
            }, 15000);
        } catch (e) { console.error(e); }
    }

    function stopRecognition() {
        if (recognition) {
            recognition.stop();
            resetMicBtn();
        }
    }

    function resetMicBtn() {
        const btn = document.getElementById('mic-btn');
        btn.classList.remove('listening');
        btn.innerText = "ğŸ¤ é–‹å§‹å£èªª";
    }

    function resetSendButton() {
        const checkBtn = document.getElementById('check-btn');
        checkBtn.innerText = "ğŸš€ é€å‡ºç­”æ¡ˆ";
        checkBtn.style.backgroundColor = "var(--send)";
        checkBtn.disabled = false;
        document.getElementById('user-input').style.borderColor = "#ddd";
    }

    function initMenu() {
        const menu = document.getElementById('lesson-menu');
        menu.innerHTML = "";
        Object.keys(allLessons).forEach(name => {
            const btn = document.createElement('button');
            btn.className = 'lesson-btn'; btn.innerText = name;
            btn.onclick = () => startLesson(name); menu.appendChild(btn);
        });
    }

    function startLesson(name) {
        currentQuestions = [...allLessons[name]].sort(() => Math.random() - 0.5);
        currentIndex = 0; currentScore = 0;
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('quiz-screen').style.display = 'block';
        document.getElementById('current-lesson-name').innerText = name;
        showQuestion();
    }

    function showQuestion() {
        attemptCount = 0; isCorrecting = false; hasBeenCorrect = false;
        const q = currentQuestions[currentIndex];
        document.getElementById('chinese-text').innerText = q.ch;
        const userInput = document.getElementById('user-input');
        userInput.value = ""; userInput.style.borderColor = "#ddd"; userInput.disabled = false;
        document.getElementById('feedback').innerText = "";
        document.getElementById('ans-display').style.display = "none";
        document.getElementById('correct-btn').style.display = "none";
        document.getElementById('progress').innerText = `${currentIndex + 1} / ${currentQuestions.length}`;
        document.getElementById('score').innerText = `å¾—åˆ†: ${currentScore}`;
        resetSendButton();
        userInput.focus();
    }

    function checkAnswer() {
        const userInput = document.getElementById('user-input');
        const userValue = userInput.value.trim();
        const checkBtn = document.getElementById('check-btn');
        const feedback = document.getElementById('feedback');
        const correctAnswer = currentQuestions[currentIndex].sp;
        const userClean = normalizeText(userValue);
        const correctClean = normalizeText(correctAnswer);

        // å¦‚æœæŒ‰éˆ•è™•æ–¼é¡¯ç¤ºç­”æ¡ˆæ¨¡å¼ï¼Œç›´æ¥æ­æ›‰
        if (checkBtn.innerText === "é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ") {
            feedback.innerText = "æ­£ç¢ºç­”æ¡ˆå¦‚ä¸‹ï¼š";
            feedback.style.color = "var(--voice)";
            showFullAnswer(correctAnswer);
            enterCorrectionMode(correctAnswer); // é¡¯ç¤ºç­”æ¡ˆå¾Œå¿…é ˆè¨‚æ­£
            return;
        }

        if (userClean === correctClean && userValue !== "") {
            // ç­”å°é‚è¼¯
            if (!hasBeenCorrect) {
                currentScore += 10;
                hasBeenCorrect = true; // æ¨™è¨˜å·²æ‹¿éåˆ†
            }
            feedback.innerText = "Â¡Excelente! ç­”å°äº†ï¼ğŸŒŸ";
            feedback.style.color = "var(--success)";
            userInput.style.borderColor = "var(--success)";
            showFullAnswer(correctAnswer);
            
            checkBtn.innerText = "ğŸš€ å†æ¬¡é€å‡º (é‡è¤‡ç·´ç¿’)";
            checkBtn.style.backgroundColor = "var(--success)";
            document.getElementById('score').innerText = `å¾—åˆ†: ${currentScore}`;
        } else {
            // ç­”éŒ¯é‚è¼¯
            attemptCount++;
            if (attemptCount === 1) {
                feedback.innerText = "ä¸å®Œå…¨æ­£ç¢ºï¼Œè«‹ä¿®æ­£æˆ–å†æŒ‰ä¸€æ¬¡é€å‡ºä»¥é¡¯ç¤ºç­”æ¡ˆã€‚";
                feedback.style.color = "var(--danger)";
                userInput.style.borderColor = "var(--danger)";
                checkBtn.innerText = "é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ";
                checkBtn.style.backgroundColor = "var(--warn)";
            } else {
                feedback.innerText = "è«‹æ ¹æ“šç­”æ¡ˆé€²è¡Œè¨‚æ­£ï¼š";
                feedback.style.color = "var(--voice)";
                showFullAnswer(correctAnswer);
                enterCorrectionMode(correctAnswer);
            }
        }
    }

    function enterCorrectionMode(correctAnswer) {
        isCorrecting = true;
        const userInput = document.getElementById('user-input');
        const checkBtn = document.getElementById('check-btn');
        const correctBtn = document.getElementById('correct-btn');

        userInput.value = "";
        userInput.placeholder = "è«‹ç…§è‘—è¼¸å…¥ä¸€æ¬¡æ­£ç¢ºç­”æ¡ˆä»¥è¨‚æ­£...";
        checkBtn.innerText = "è«‹æŒ‰ä¸‹ä¸€é¡Œ";
        checkBtn.disabled = true; // è¨‚æ­£æ¨¡å¼ä¸‹ï¼Œé€å‡ºéˆ•æš«æ™‚å¤±æ•ˆ
        correctBtn.style.display = "block";
        correctBtn.innerText = "è¨‚æ­£ä¸­...";
        correctBtn.disabled = true;
        correctBtn.style.backgroundColor = "var(--warn)";
    }

    function handleTyping() {
        const userInput = document.getElementById('user-input');
        const checkBtn = document.getElementById('check-btn');
        
        if (isCorrecting) {
            const correctBtn = document.getElementById('correct-btn');
            const correctAnswer = currentQuestions[currentIndex].sp;
            if (normalizeText(userInput.value) === normalizeText(correctAnswer)) {
                correctBtn.innerText = "è¨‚æ­£å®Œæˆ <";
                correctBtn.style.backgroundColor = "var(--success)";
                correctBtn.disabled = false;
                userInput.style.borderColor = "var(--success)";
            } else {
                correctBtn.innerText = "è¨‚æ­£ä¸­...";
                correctBtn.disabled = true;
                correctBtn.style.backgroundColor = "var(--warn)";
            }
            return;
        }

        // éè¨‚æ­£æ¨¡å¼ï¼Œæ–‡å­—è®Šå‹•å³é‡ç½®ç‚ºé€å‡ºç‹€æ…‹
        if (checkBtn.innerText !== "ğŸš€ é€å‡ºç­”æ¡ˆ" && checkBtn.innerText !== "é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ") {
            resetSendButton();
        }
        userInput.style.borderColor = "#ddd";
    }

    function checkCorrection() {
        document.getElementById('feedback').innerText = "è¨‚æ­£æˆåŠŸï¼è«‹é»æ“Šã€Œä¸‹ä¸€é¡Œã€ã€‚";
        document.querySelector('.btn-next').style.backgroundColor = "var(--primary)";
    }

    function normalizeText(text) {
        return text.toLowerCase().replace(/[Â¿?.,!]/g, "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
    }

    function showFullAnswer(text) {
        const ansDisp = document.getElementById('ans-display');
        const words = text.split(' ');
        ansDisp.innerHTML = words.map(word => /[Ã¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘]/.test(word) ? `<span style="color:red; font-weight:bold;">${word}</span>` : word).join(' ') + " ğŸ”Š";
        ansDisp.style.display = "block";
        speak(text);
    }

    function nextQuestion() {
        if (currentIndex < currentQuestions.length - 1) { 
            currentIndex++; showQuestion(); 
            document.querySelector('.btn-next').style.backgroundColor = "var(--secondary)";
        }
        else { alert("èª²ç¨‹çµæŸï¼"); goToMenu(); }
    }

    function goToMenu() { document.getElementById('menu-screen').style.display = 'block'; document.getElementById('quiz-screen').style.display = 'none'; }
    function speak(text) { const u = new SpeechSynthesisUtterance(text); u.lang = 'es-ES'; window.speechSynthesis.speak(u); }
    function speakCurrent() { speak(currentQuestions[currentIndex].sp); }

    initMenu();
</script>
</body>
</html>


